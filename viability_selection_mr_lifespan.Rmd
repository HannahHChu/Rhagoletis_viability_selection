---
title: "viability_selection_mr_lifespan"
output: 
  html_document: 
    toc: yes
---

#Libraries
```{r}
library(dplyr) #data parsing library
library(data.table) #data parsing library mainly for reading and writing out
library(ggplot2) #data visualization library
library(lubridate) #package to deal with time variables
library(curl)
```

# Download data and do preliminary parsing
Data are publicly available via [github](https://raw.githubusercontent.com/adnguyen/Circadian_rhythm_runs_seasonal_timing/master/Data/2018-05-30_rhagoletis_masterdata_data_slice.csv)
```{r}
data<- fread("https://raw.githubusercontent.com/adnguyen/Circadian_rhythm_runs_seasonal_timing/master/Data/2018-05-30_rhagoletis_masterdata_data_slice.csv")

#look at summary of data
glimpse(data)
```

#Calculating metabolic rates
```{r}
glimpse(data$purge_time_1)
hm(data$purge_time_1)
data$day10purge <- lubridate::hour(hm(data$purge_time_1))+lubridate::minute(hm(data$purge_time_1))/60

#figure out how to create a time sequence
start<-13.26667
end<- 14.5
n=75
seq(start,end, length.out = n)

#Getting start and end (min and max) of purges and smaple size for each host, cohort day, and tape
param <- data%>%
  group_by(cohort_day, tape)%>%
  summarise(max=max(day10purge, na.rm=TRUE), min=min(day10purge, na.rm=TRUE), n=length(cohort_day))

#goal: for this section, we want a sequence of times for day 10 purge
data2 <- data%>%
  group_by(cohort_day, tape)%>%
  mutate(.,day10purge.trans=seq(from = min(day10purge, na.rm=TRUE), to = max(day10purge, na.rm=TRUE), length.out = length(Host)))
glimpse(data2)

#cohort 2&3 for apple have the right sequence of purge times so they(day10purge) need to be replaced into corresponding day10purge.trans column
#extracting number of rows we want to replace
data2[1:500,]%>%
  filter(cohort_day < 4)%>%
  dim()
data2[1:211,46]<- data2[1:211,45]
data2[1:211,46]

#calculating start and end time
glimpse(data$resp_time_1)
hms(data$resp_time_1)
data2$day10resp <- lubridate::hour(hms(data$resp_time_1))+lubridate::minute(hms(data$resp_time_1))/60

data2$total_time_day10 <- (24 - data2$day10purge.trans) + data2$day10resp

#getting denominator for mass-specific mr
data2$total_time_day10 * data$mass_day10

data2$MR11<- data$resp_day11/(data2$total_time_day10)
data2$msMR11<- data$resp_day11/(data2$total_time_day10 * data$mass_day10)

#need to control for blank controls
data3 <- data2%>%
  group_by(cohort_day, tape)%>%
  filter(Site_name=="Blank")%>%
  summarise(mean.blank=mean(MR11,na.rm=TRUE))
#check columns
glimpse(data3)
data3$mean.blank

#merge data3 and data2 by cohort day and tape
data4 <- inner_join(data2, data3, by=c("cohort_day", "tape"))
data4
data4$mean.blank

#do some corrections
data5 <- data4%>%
  mutate(MR11.cor = MR11 - mean.blank, msMR11.cor = msMR11 - mean.blank)
glimpse(data5)

data5.neg <- data5%>% 
  filter(MR11.cor<0)%>%
  dim()
  #select(.,c("cohort_day","tape", "uniqueID", "MR11.cor"))
   #fwrite(data5.neg,"2018-05-31_negative_MR.csv")

#ggplot(data5.neg, aes(x=MR11.cor))+geom_histogram()
```

## Figures of mr between hosts
```{r}
ggplot(data5, aes(x=Host, y=MR11.cor))+geom_boxplot()
ggplot(data5, aes(x=MR11.cor, fill=(Host)))+geom_histogram(position = "identity", alpha=.5)
```
#Calculate eclosion days
```{r}
data5$neweclosions<-difftime(as.Date(data5$eclosion_date), as.Date(data5$Eclosion_reference_date),units=c("days"))+15
```
#Explore eclosion data
```{r}
ggplot(data5.treatsub, aes(x=MR11.cor, fill=(Host)))+geom_histogram(position = "identity", alpha=.5)+facet_grid(.~treatment)

a<-ggplot(data5.treatsub, aes(x=MR11.cor, fill=(Host)))+geom_density(position = "identity", alpha=.5)+facet_grid(.~treatment)

b<-ggplot(data5.treatsub, aes(x=neweclosions, fill=(Host)))+geom_density(position = "identity", alpha=.5)+facet_grid(.~treatment)

#4 panel
install.packages("gridExtra")
library(gridExtra)
grid.arrange(nrow=2,a,b)

```
###Test differences in eclosion timing between host and experiment
```{r}
mod1<- aov(neweclosions~Host*treatment, data=data5.treatsub)
summary(mod1)

#narrow down to SO
data5.SO<-data5.treatsub%>%
  filter(treatment=="SO")

mod2<-aov(neweclosions~Host, data=data5.SO)
summary(mod2)

#how balanced it is
data5.SO%>%
  group_by(Host)%>%
  summarise(n=length(Host))
```
#Explore relationship between eclosion days and MR
**scatter plots**
```{r}

data5.treatsub<-data5%>%
  filter(treatment!="GC"&treatment!="")

ggplot(data5.treatsub,aes(x=MR11.cor, y=neweclosions, colour=Host))+geom_point()+stat_smooth(method="loess")+facet_grid(.~treatment)

#plotting mr11 on the x axis and new eclosions on the y axis; color points by host, fit curve to data
ggplot(data5.treatsub,aes(x=MR11.cor, y=neweclosions, colour=Host))+geom_point()+stat_smooth(method="loess")


#same - fit linear curve to data
ggplot(data5.treatsub,aes(x=MR11.cor, y=neweclosions, colour=Host))+geom_point()+stat_smooth(method="lm")

#could log transform mr to make it more linear
ggplot(data5.treatsub,aes(x=log10(MR11.cor), y=neweclosions, colour=Host))+geom_point()+stat_smooth(method="lm") + xlim(-3.2,-.5)
```

#Calculating lifespan
```{r}
data5.treatsub$lifespan<-difftime(as.Date(data5.treatsub$Adult_death_date, na.rm=TRUE), as.Date(data5.treatsub$eclosion_date, na.rm=TRUE),units=c("days"))

#finding negative lifespans
lsneg <- data5.treatsub%>% 
  filter(lifespan < 0) %>%
  select(uniqueID,cohort_day, tape)

```

## Figures of lifespan between hosts
```{r}

ggplot(data5.treatsub, aes(x=Host, y=lifespan))+geom_boxplot()
ggplot(data5.treatsub, aes(x=lifespan, fill=(Host)))+geom_histogram(position = "identity", alpha=.5)

```

#Associating MR with lifespan
```{r}

ggplot(data5.treatsub,aes(x= MR11.cor, y=lifespan, colour=Host))+geom_point()+stat_smooth(method="loess") + facet_grid(.~treatment)

a<- ggplot(data5.treatsub,aes(x=MR11.cor, y=lifespan, colour=Host))+geom_point()+stat_smooth(method="lm") + facet_grid(.~treatment)

ggplot(data5.treatsub,aes(x=log10(MR11.cor), y=lifespan, colour=Host))+geom_point()+stat_smooth(method="loess") + xlim(-3.2,-.5) + ylim(-.5, 150)

```


## Repeat above, but with day 15
```{r}
glimpse(data$purge_time_2)
hm(data$purge_time_2)
data$day15purge <- lubridate::hour(hm(data$purge_time_2))+lubridate::minute(hm(data$purge_time_2))/60

#figure out how to create a time sequence
start<-13.26667
end<- 14.5
n=75
seq(start,end, length.out = n)

#Getting start and end (min and max) of purges and sample size for each host, cohort day, and tape
param <- data%>%
  group_by(cohort_day, tape)%>%
  summarise(max=max(day15purge, na.rm=TRUE), min=min(day10purge, na.rm=TRUE), n=length(cohort_day))

#goal: for this section, we want a sequence of times for day 10 purge
data2.15 <- data%>%
  group_by(cohort_day, tape)%>%
  mutate(.,day15purge.trans=seq(from = min(day15purge, na.rm=TRUE), to = max(day15purge, na.rm=TRUE), length.out = length(Host)))
glimpse(data2.15)

#calculating start and end time
glimpse(data$resp_time_2)
hms(data$resp_time_2)
data2.15$day15resp <- lubridate::hour(hms(data$resp_time_2))+lubridate::minute(hms(data$resp_time_2))/60

data2.15$total_time_day15 <- (24 - data2.15$day15purge.trans) + data2.15$day15resp

#getting denominator for mass-specific mr
data2.15$total_time_day15 * data$mass_day14

data2.15$MR15<- data$resp_day15/(data2.15$total_time_day15)
data2.15$msMR15<- data$resp_day15/(data2.15$total_time_day15 * data$mass_day14)

#need to control for blank controls
data3.15 <- data2.15%>%
  group_by(cohort_day, tape)%>%
  filter(Site_name=="Blank")%>%
  summarise(mean.blank2=mean(MR15,na.rm=TRUE))
#check columns
glimpse(data3.15)
data3.15$mean.blank2

#merge data3 and data2 by cohort day and tape
data4.15 <- inner_join(data2.15, data3.15, by=c("cohort_day", "tape"))
data4.15
data4.15$mean.blank2

#do some corrections
data5.15 <- data4.15%>%
  mutate(MR15.cor = MR15 - mean.blank2, msMR15.cor = msMR15 - mean.blank2)
glimpse(data5.15)

data5.15.neg <- data5.15%>% 
  filter(MR15.cor<0)%>%

  #select(.,c("cohort_day","tape", "uniqueID", "MR11.cor"))
   #fwrite(data5.neg,"2018-05-31_negative_MR.csv")

#ggplot(data5.neg, aes(x=MR11.cor))+geom_histogram()

#Neweclosions
data5.15$neweclosions <- difftime(as.Date(data5.15$eclosion_date), as.Date(data5.15$Eclosion_reference_date),units=c("days"))+15

#figures of mr b/w hosts

ggplot(data5.15, aes(x=Host, y=MR15.cor))+geom_boxplot()

ggplot(data5.15, aes(x=MR15.cor, fill=(Host)))+geom_histogram(position = "identity", alpha=.5)
#eclosion data
data5.15.treatsub$neweclosions<-difftime(as.Date(data5.15.treatsub$eclosion_date), as.Date(data5.15.treatsub$Eclosion_reference_date),units=c("days"))+15

#scatter plots
data5.15.treatsub<-data5.15%>%
  filter(treatment!="GC"&treatment!="")

ggplot(data5.15.treatsub, aes(x=MR15.cor, y=neweclosions, colour=Host))+geom_point()+stat_smooth(method="loess")+facet_grid(.~treatment)

#plotting mr15 on the x axis and new eclosions on the y axis; color points by host, fit curve to data
ggplot(data5.15.treatsub,aes(x=MR15.cor, y=neweclosions, colour=Host))+geom_point()+stat_smooth(method="loess")

#same - fit linear curve to data
ggplot(data5.15.treatsub,aes(x=MR15.cor, y=neweclosions, colour=Host))+geom_point()+stat_smooth(method="lm")

#could log transform mr to make it more linear
ggplot(data5.15.treatsub,aes(x=log10(MR15.cor), y=neweclosions, colour=Host))+geom_point()+stat_smooth(method="lm") + xlim(-3.2,-.5)


#mr15 w lifespan
data5.15.treatsub$lifespan<-difftime(as.Date(data5.15.treatsub$Adult_death_date, na.rm=TRUE), as.Date(data5.15.treatsub$eclosion_date, na.rm=TRUE),units=c("days"))

ggplot(data5.15.treatsub,aes(x= MR15.cor, y=lifespan, colour=Host))+geom_point()+stat_smooth(method="loess") + facet_grid(.~treatment)

ggplot(data5.15.treatsub,aes(x=MR15.cor, y=lifespan, colour=Host))+geom_point()+stat_smooth(method="lm") + facet_grid(.~treatment)

ggplot(data5.15.treatsub,aes(x=log10(MR15.cor), y=lifespan, colour=Host))+geom_point()+stat_smooth(method="lm")

grid.arrange(nrow=2,a,b)
```

#Negative binomial regression to determine the effect of metabolic rate on lifespan between hosts and its' treatments
```{r}
library(MASS)
#determining class
class(data5.15.treatsub$lifespan)
data5.15.treatsub$lifespan<-as.numeric(data5.15.treatsub$lifespan)

#model2<-glm.nb(lifespan~MR15.cor*Host*treatment, data=data5.15.treatsub)


#separating out RT and SO 
RT15 <- data5.15.treatsub%>%
    filter(treatment=="RT")

SO15 <- data5.15.treatsub%>%
    filter(treatment=="SO")

#RT summary (no stat significance)
mod3<- glm.nb(lifespan~MR15.cor*Host, data=RT15)
summary(mod3)

#SO summary : HostHaw (in reference to apple) - as lifespan increases, the MR decreases by the estimate (logvalue)
  #mod4 shows interaction b/w host and mr
mod4<-glm.nb(lifespan~MR15.cor*Host, data=SO15)
summary(mod4)

#mod6 shows how mr and host individually relate to lifespan
mod6<-glm.nb(lifespan~MR15.cor + Host, data=SO15)
summary(mod6)

#Likelihood ratio tests of Negative Binomial Models
m1 <- update(mod4, . ~ . - prog)
anova(mod4, m1)

#Checking model assumption -- is negative binomial regression (NBR) a good model for this data?
##Values close to 0 (estimates the dispersion parameter) strongly suggest the NBR model is more appropriate than the Poisson model
mod5 <- glm(lifespan ~ Host*MR15.cor, family = "poisson", data = SO15)
pchisq(2 * (logLik(mod4) - logLik(mod5)), df = 1, lower.tail = FALSE)

#output below indicates that Hawthorne is 0.432 times less likely to live than apple
#confidence interval
(est <- cbind(Estimate = coef(mod4), confint(mod4)))
#incident rate ratio - lifespan ratio
exp(est)

#Filter out all the NAs in order to have same dimensions for predvalues
filSO15<- SO15%>%
  filter(MR15.cor!= "NA"&lifespan !="NA")

#Calculate the predicted values
filSO15$predvalues <- predict(mod6, type = "response")
glimpse(filSO15)


#overlay of real data(points)  with predicted values(line)
a<-ggplot(filSO15,aes(x=MR15.cor, y=lifespan, colour=Host))+geom_point()+geom_line(data=filSO15, aes(x=MR15.cor, y=predvalues, colour=Host))
```

# Double Checking Eclosion for Pupal Deaths
```{r}
#Assign names to each column and column bind in order to simplify and find data easily 
host <- data[,11]
cd <- data[,10]
wid <- data[,29]
unid<-data[,26]
edate <- data[,27]
dcheck<-cbind(host, cd, wid, unid, edate)
```

#Merging pupal death data sheet lifespans
Data available on [github](https://raw.githubusercontent.com/adnguyen/Circadian_rhythm_runs_seasonal_timing/master/Data/2018-06-04_pupal_deaths_data.csv)
```{r}
pupdeaths<- fread("https://raw.githubusercontent.com/adnguyen/Circadian_rhythm_runs_seasonal_timing/master/Data/2018-06-04_pupal_deaths_data.csv")

#Filter out non-eclosers
data5.na <- data5.15%>%
  mutate(neweclosions=as.numeric(neweclosions))%>%
  #glimpse()
  filter(is.na(neweclosions))

#Filter out individuals with adult lifespans
data5.ls <- data5.15.treatsub%>%
  filter(!is.na(lifespan))

#Merge the two sets of data (lifespan and non-eclosers) by "Host", "cohort_day", "well_id", and "uniqueID"
mergedat1 <- inner_join(pupdeaths, data5.na, by = c("Host", "cohort_day", "well_id", "uniqueID"))

#column bind the merged data with the lifespan data to check same column dim
cbind(names(data5.ls), names(mergedat1)[-56])

#once the column dimensions are the same, merge the two sets of data
mergedata<- merge(data5.ls, mergedat1)

#Finally, row bind the data with the desired conditions
finalmerge<- rbind(data5.ls[,c("Host", "cohort_day", "well_id", "uniqueID", "lifespan", "MR15.cor", "treatment", "mass_day14")], mergedat1[,c("Host", "cohort_day", "well_id", "uniqueID", "lifespan", "MR15.cor", "treatment", "mass_day14")])

glimpse(finalmerge)

```

#Negative binomial regression reanalyzed with pupal death data
```{r}
RT15.n <- finalmerge%>%
    filter(treatment=="RT")

SO15.n <- finalmerge%>%
    filter(treatment=="SO")

#RT summary (no stat significance)
mod3.n<- glm.nb(lifespan~MR15.cor*Host, data=RT15.n)
summary(mod3.n)

#SO summary : HostHaw (in reference to apple) - as lifespan increases, the MR decreases by the estimate (logvalue)
  #mod4 shows interaction b/w host and mr
mod4.n<-glm.nb(lifespan~MR15.cor*Host, data=SO15.n)
summary(mod4.n)

#mod6 shows how mr and host individually relate to lifespan
mod6.n<-glm.nb(lifespan~MR15.cor + Host, data=SO15.n)
summary(mod6)

#Likelihood ratio tests of Negative Binomial Models
m1.n <- update(mod4.n, . ~ . - prog)
anova(mod4.n, m1.n)

#Checking model assumption -- is negative binomial regression (NBR) a good model for this data?
##Values close to 0 (estimates the dispersion parameter) strongly suggest the NBR model is more appropriate than the Poisson model
mod5.n <- glm(lifespan ~ Host*MR15.cor, family = "poisson", data = SO15.n)
pchisq(2 * (logLik(mod4.n) - logLik(mod5.n)), df = 1, lower.tail = FALSE)

#output below indicates that Hawthorne is 0.432 times less likely to live than apple
#confidence interval
(est <- cbind(Estimate = coef(mod6.n), confint(mod6.n)))
#incident rate ratio - lifespan ratio
exp(est)

#Filter out all the NAs in order to have same dimensions for predvalues
filSO15.n<- SO15.n%>%
  filter(MR15.cor!= "NA"&lifespan !="NA")

#Calculate the predicted values
filSO15.n$predvalues <- predict(mod6.n, type = "response")
glimpse(filSO15.n)


#overlay of real data(points)  with predicted values(line)
b<-ggplot(filSO15.n,aes(x=MR15.cor, y=lifespan, colour=Host))+geom_point()+geom_line(data=filSO15.n, aes(x=MR15.cor, y=predvalues, colour=Host))

#comparison of non-pupal deaths w/ pupal deaths
grid.arrange(nrow=2,a,b)
```

# Kaplan-Meier Survival Estimate
```{r}
#install.packages(c("survival", "survminer"))
#install.packages(c("ggpubr", "magrittr"))
library(survival)
library(survminer)

#Assign censored data and create new column
finalmerge$status[finalmerge$lifespan == 0] <- 0
finalmerge$status[finalmerge$lifespan > 0 ] <- 1
finalmerge

#Normalize data
#install.packages("BBmisc")
library(BBmisc)
n.finalmerge<-normalize(finalmerge [], method = "standardize", range = c(0, 1), margin = 1L, on.constant = "quiet")

#compute kaplan-Meier survival estimate-so compute the survival probability by host & treatment:
  #fit1 computes survival probability by Host only
  #fit2 computes survival probability by Treatment only
  #fit3 computes survival probability by Host + Treatment

fit1 <- survfit(Surv(lifespan, status) ~ Host, data = finalmerge)
print(fit1)

fit2 <- survfit(Surv(lifespan, status) ~ treatment, data = finalmerge)
print(fit2)

fit3 <- survfit(Surv(lifespan, status) ~ Host + treatment, data = finalmerge)
print(fit3)

# Summary of survival curves
summary(fit1) 
summary(fit2)
summary(fit3)

# Access to the sort summary table
summary(fit1)$table
summary(fit2)$table
summary(fit3)$table

# Visualize curves (Change color, linetype by strata, risk.table color by strata)
h<-ggsurvplot(fit1,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          xlab = "Lifespan in days",
           legend.title = "Conditions",
          pval.size=4)

tt<-ggsurvplot(fit2,
          pval = TRUE, conf.int = FALSE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#DBAECB", "#2E9FDF","#E7B800"),
          xlab = "Lifespan in days",
          legend.title = "Conditions",
          pval.size=4)

both<-ggsurvplot(fit3,
          pval = TRUE, conf.int = FALSE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = c("dashed","solid", "dashed", "dashed","solid"), # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#F9E996","#FFD700","#A9A9A9","#496DA1","#204A87"),
          xlab = "Lifespan in days",
          legend.title = "Conditions",
          pval.size=4)
install.packages("grid")
grid.arrange(grobs=lapply(list(h, tt, both), grobTree), ncol=3)
```

# Session Info
```{r}
sessionInfo()
```